name: Build TCMT Windows Client

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev, feature/iflow-cli-integration ]
  workflow_dispatch:

env:
  SOLUTION_FILE_PATH: Project1/Project1.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64
  TZ: Asia/Shanghai

jobs:
  build:
    name: 编译与日志生成 (Windows)
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v5
        with:
          ref: feature/iflow-cli-integration
          submodules: recursive
          fetch-depth: 0

      - name: 生成 S.A.E.R 系统环境报告
        shell: pwsh
        run: |
          $report = "saer.txt"
          "=== SYSTEM AND ENVIRONMENT REPORT ===" | Out-File $report
          "" | Out-File $report -Append
          "Timestamp (UTC): $(Get-Date -AsUTC)" | Out-File $report -Append
          "" | Out-File $report -Append
          "== Hardware ==" | Out-File $report -Append
          Get-CimInstance -ClassName Win32_ComputerSystem |
            Select-Object Manufacturer, Model,
              @{Name="TotalPhysicalMemory(GB)";Expression={[math]::Round($_.TotalPhysicalMemory/1GB,2)}} |
            Format-Table | Out-File $report -Append
          "" | Out-File $report -Append
          "== CPU ==" | Out-File $report -Append
          Get-CimInstance -ClassName Win32_Processor |
            Select-Object Name, NumberOfCores, NumberOfLogicalProcessors, MaxClockSpeed |
            Format-Table | Out-File $report -Append
          "" | Out-File $report -Append
          "== OS & Arch ==" | Out-File $report -Append
          "OS: $env:OS" | Out-File $report -Append
          "PROCESSOR_ARCHITECTURE: $env:PROCESSOR_ARCHITECTURE" | Out-File $report -Append
          "" | Out-File $report -Append
          "== Git Version ==" | Out-File $report -Append
          (git --version) | Out-File $report -Append
          "" | Out-File $report -Append
          "== Key Environment Variables ==" | Out-File $report -Append
          Get-ChildItem Env: |
            Where-Object { $_.Name -match 'PATH|CUDA|MSBUILD|VISUAL|GITHUB|RUNNER' } |
            Select-Object Name, Value |
            Format-Table | Out-File $report -Append
          "" | Out-File $report -Append
          "== Repo File Tree (Top 150) ==" | Out-File $report -Append
          (git ls-tree -r --name-only HEAD | Select-Object -First 150) | Out-File $report -Append

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Cache CUDA Toolkit
        id: cache-cuda
        uses: actions/cache@v4
        with:
          path: C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6
          key: cuda-12.6-${{ runner.os }}

      - name: Setup CUDA 12.6
        if: steps.cache-cuda.outputs.cache-hit != 'true'
        uses: Jimver/cuda-toolkit@v0.2.18
        with:
          cuda: '12.6.0'
          method: 'network'

      - name: Cache NuGet packages
        id: cache-nuget
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.sln','**/*.csproj','**/packages.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: NuGet & Dotnet Restore
        if: steps.cache-nuget.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          nuget restore ${{ env.SOLUTION_FILE_PATH }}
          dotnet restore ${{ env.SOLUTION_FILE_PATH }}

      - name: Cache MSBuild (metadata only)
        id: cache-msbuild
        uses: actions/cache@v4
        with:
          path: C:\Program Files (x86)\Microsoft Visual Studio\2022\Enterprise\MSBuild
          key: msbuild-${{ runner.os }}-${{ hashFiles('**/*.sln') }}
          restore-keys: msbuild-${{ runner.os }}-

      - name: Build Solution
        id: build-solution
        shell: pwsh
        continue-on-error: true
        run: |
          msbuild ${{ env.SOLUTION_FILE_PATH }} `
            /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
            /p:Platform=${{ env.BUILD_PLATFORM }} `
            /p:PlatformToolset=v143 `
            /p:WindowsTargetPlatformVersion=10.0 `
            /m /verbosity:minimal 2>&1 | Tee-Object -FilePath solution_build.log
          $exitCode = $LASTEXITCODE

          if (!(Test-Path solution_build.log)) {
            "Build log was not generated" | Out-File solution_build.log
          }

          $fatalErrors = @()
          $warnings = 0
          $errorPatterns = @(
            'fatal error', 'fatal: ', 'error LNK\d{4}', 'LNK\d{4}',
            'unresolved external symbol', 'undefined reference',
            'LINK : fatal error', 'error CS\d+:', 'NETSDK\d+:'
          )

          Get-Content solution_build.log | ForEach-Object {
            $line = $_
            if ($line -match '(?i)\bwarning\b') { $warnings++ }
            foreach ($p in $errorPatterns) {
              if ($line -match $p) { $fatalErrors += $line; break }
            }
          }

          $fatalErrors | Out-File solution_build.errors.txt
          "Warnings: $warnings" | Out-File solution_build.errors.txt -Append
          "ExitCode: $exitCode" | Out-File solution_build.errors.txt -Append

          if ($fatalErrors.Count -gt 0) {
            Write-Host "##[error] Build failed with $($fatalErrors.Count) fatal error lines."
            exit 1
          } elseif ($exitCode -ne 0) {
            Write-Host "##[warning] Non-zero exit code ($exitCode) but no fatal patterns matched."
          } else {
            Write-Host "Build finished successfully."
          }

      - name: Upload Logs & Env Report
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            saer.txt
            solution_build.log
            solution_build.errors.txt

      - name: Upload Build Outputs
        uses: actions/upload-artifact@v4
        with:
          name: win-build-output
          path: |
            Project1/x64/${{ env.BUILD_CONFIGURATION }}/*.exe
            Project1/x64/${{ env.BUILD_CONFIGURATION }}/*.dll
          if-no-files-found: warn

  analyze-and-feedback:
    name: 构建决策与汇总反馈 (Ubuntu)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: 下载构建日志与环境
        uses: actions/download-artifact@v4
        with:
          name: build-logs
          path: .

      - name: (可选) 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: win-build-output
          path: ./build_output
        continue-on-error: true

      # ---------- 决策步骤（独立） ----------
      - name: Run iFlow Build Decision
        id: iflow-decision
        uses: iflow-ai/iflow-cli-action@v2.0.0
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          model: "glm-4.6"
          timeout: "900"
          working_directory: "."
          prompt: |
            你现在执行“构建决策”分析。生成 build_decision.json（UTF-8，无 BOM），不要在控制台打印 JSON 正文。
            模块：
              C++: src/core/, src/main.cpp, src/CPP-parsers/
              WPF: WPF-UI1/ 下 .xaml/.cs
              第三方: src/third_party/
            获取 diff：git diff --name-only HEAD~1 HEAD；失败或为空 → 视为无 diff。
            规则：
              - diff 命中 main.cpp 或 src/core/ 任意文件 → build_cpp=true
              - diff 命中 WPF-UI1/ .xaml/.cs → build_wpf=true
              - diff 命中 src/third_party/ → build_lib=true
            use_cache：
              - diff 文件数 ≤8 且未命中 src/core/ 或 main.cpp 且未命中第三方大型库文件 (.lib/.dll/.h 新增或删除) → true
              - 否则 false
            priority：
              - 仅包含为 true 的模块
              - build_cpp=true → cpp 排第一
              - build_lib=true 且其 diff 中含头文件/库文件(.h/.lib/.dll) → lib 在 cpp 前；否则在 cpp 后
              - wpf 在最后（除非只有 wpf）
            无 diff 兜底：
              build_cpp=true, build_wpf=true, build_lib=true, use_cache=false, priority=["cpp","lib","wpf"], reason="无 diff，全量构建"
            若全部 false → 兜底 build_cpp=true，reason 含“兜底”说明。
            输出字段与顺序：
            {
              "build_cpp": <bool>,
              "build_wpf": <bool>,
              "build_lib": <bool>,
              "use_cache": <bool>,
              "priority": [ ... ],
              "reason": "≤400中文字符"
            }
            priority 不含 false 模块；不加额外字段；true/false 小写。
            仅写文件 build_decision.json。

      - name: 上传构建决策
        uses: actions/upload-artifact@v4
        with:
          name: build-decision
          path: build_decision.json

      # ---------- 汇总步骤（独立） ----------
      - name: Run iFlow Build Summary
        id: iflow-summary
        uses: iflow-ai/iflow-cli-action@v2.0.0
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          model: "glm-4.6"
          timeout: "900"
            # 若不是 PR 也要运行以产出总结文件，但仅在 PR 事件评论
          working_directory: "."
          prompt: |
            执行构建结果汇总，读取：saer.txt, solution_build.log, build_decision.json(若存在)。
            输出 build_summary.json（UTF-8，无 BOM），结构：
            {
              "overall_status":"success|failure|partial",
              "components":{
                "cpp":{"status":"success|failure|unknown","errors":0,"warnings":0},
                "wpf":{"status":"success|failure|unknown","errors":0,"warnings":0},
                "lib":{"status":"success|failure|unknown","errors":0,"warnings":0},
                "main":{"status":"success|failure|unknown","errors":0,"warnings":0}
              },
              "key_issues":[...≤12],
              "recommendations":[...],
              "summary_text":"≤600中文字符总结"
            }
            日志解析（solution_build.log）：
              errors 匹配：fatal error|fatal:|unresolved external symbol|undefined reference|LINK : fatal error|LNK\d{4}|NETSDK\d+|error CS\d+
              warnings 匹配：\bwarning\b
            模块状态：
              命中 C++ 路径相关错误 → cpp=failure
              命中 WPF-UI1 路径错误 → wpf=failure
              命中 src/third_party 错误 → lib=failure
              任一 fatal/link/NETSDK 错误 → main=failure
              未判定 → unknown
            overall_status：
              全 success → success
              有 failure 且有 success → partial
              全 failure 或 main=failure → failure
            无日志兜底：overall_status=failure，全部 unknown，key_issues=["缺少构建日志"]，recommendations=["检查构建日志采集"]。
            key_issues 只选最重要（fatal/link/符号缺失/依赖），多于12截断。
            recommendations 针对问题给可执行短语，如：
              - 检查第三方库版本兼容
              - 修复 unresolved external symbol
              - 重新还原 NuGet 包
              - 处理 WPF XAML 绑定错误
            summary_text 结构（不带 JSON）：
              行1 总体 + 简述
              行2 模块状态 (只列出现的：CPP=成功/失败, WPF=..., LIB=..., MAIN=...)
              行3 关键问题概述 + 建议（用顿号或分号分隔） 换行 ≤3
            写文件后：
              若是 PR 事件 (github.event_name == 'pull_request') → 自动用 GITHUB_TOKEN 评论 summary_text 到该 PR。
              非 PR 不评论。
            仅写 build_summary.json（不要在控制台打印 JSON 正文）。

      - name: 上传构建汇总
        uses: actions/upload-artifact@v4
        with:
            name: build-summary
            path: build_summary.json

      # 备用评论（仅当 iflow action 不支持自动评论时取消注释）
      # - name: 备用：PR 评论
      #   if: github.event_name == 'pull_request'
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const fs = require('fs');
      #       if (!fs.existsSync('build_summary.json')) {
      #         github.issues.createComment({
      #           issue_number: context.issue.number,
      #           owner: context.repo.owner,
      #           repo: context.repo.repo,
      #           body: '未找到 build_summary.json，无法生成汇总。'
      #         });
      #       } else {
      #         const data = JSON.parse(fs.readFileSync('build_summary.json','utf8'));
      #         github.issues.createComment({
      #           issue_number: context.issue.number,
      #           owner: context.repo.owner,
      #           repo: context.repo.repo,
      #           body: data.summary_text || 'summary_text 字段为空。'
      #         });
      #       }