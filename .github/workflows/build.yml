name: Build TCMT Windows Client

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  SOLUTION_FILE_PATH: Project1/Project1.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64
  TZ: Asia/Shanghai

jobs:
  build:
    name: 编译与日志生成 (Windows)
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 生成 S.A.E.R 系统环境报告
        shell: pwsh
        run: |
          $report = "saer.txt"
          "=== SYSTEM AND ENVIRONMENT REPORT ===" | Out-File $report
          "" | Out-File $report -Append
          "Timestamp (UTC): $(Get-Date -AsUTC)" | Out-File $report -Append
          "" | Out-File $report -Append
          "== Hardware ==" | Out-File $report -Append
          Get-CimInstance -ClassName Win32_ComputerSystem |
            Select-Object Manufacturer, Model,
              @{Name="TotalPhysicalMemory(GB)";Expression={[math]::Round($_.TotalPhysicalMemory/1GB,2)}} |
            Format-Table | Out-File $report -Append
          "" | Out-File $report -Append
          "== CPU ==" | Out-File $report -Append
          Get-CimInstance -ClassName Win32_Processor |
            Select-Object Name, NumberOfCores, NumberOfLogicalProcessors, MaxClockSpeed |
            Format-Table | Out-File $report -Append
          "" | Out-File $report -Append
          "== OS & Arch ==" | Out-File $report -Append
          "OS: $env:OS" | Out-File $report -Append
          "PROCESSOR_ARCHITECTURE: $env:PROCESSOR_ARCHITECTURE" | Out-File $report -Append
          "" | Out-File $report -Append
          "== Git Version ==" | Out-File $report -Append
          (git --version) | Out-File $report -Append
          "" | Out-File $report -Append
          "== Key Environment Variables ==" | Out-File $report -Append
          Get-ChildItem Env: |
            Where-Object { $_.Name -match 'PATH|CUDA|MSBUILD|VISUAL|GITHUB|RUNNER' } |
            Select-Object Name, Value |
            Format-Table | Out-File $report -Append
          "" | Out-File $report -Append
          "== Repo File Tree (Top 150) ==" | Out-File $report -Append
          (git ls-tree -r --name-only HEAD | Select-Object -First 150) | Out-File $report -Append

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Cache CUDA Toolkit
        id: cache-cuda
        uses: actions/cache@v4
        with:
          path: C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6
          key: cuda-12.6-${{ runner.os }}

      - name: Setup CUDA 12.6
        if: steps.cache-cuda.outputs.cache-hit != 'true'
        uses: Jimver/cuda-toolkit@v0.2.18
        with:
          cuda: '12.6.0'
          method: 'network'

      - name: NuGet & Dotnet Restore
        shell: pwsh
        run: |
          nuget restore ${{ env.SOLUTION_FILE_PATH }}
          dotnet restore ${{ env.SOLUTION_FILE_PATH }}

      - name: Cache MSBuild (metadata only)
        id: cache-msbuild
        uses: actions/cache@v4
        with:
          path: C:\Program Files (x86)\Microsoft Visual Studio\2022\Enterprise\MSBuild
          key: msbuild-${{ runner.os }}-${{ hashFiles('**/*.sln') }}
          restore-keys: msbuild-${{ runner.os }}-

      - name: Build Solution
        id: build-solution
        
        shell: pwsh
        run: |
          # First build .NET projects with dotnet build (which handles restore automatically)
          dotnet build ${{ env.SOLUTION_FILE_PATH }} --configuration ${{ env.BUILD_CONFIGURATION }} --verbosity minimal 2>&1 | Tee-Object -FilePath dotnet_build.log
          
          # Then build C++ projects with msbuild
          msbuild ${{ env.SOLUTION_FILE_PATH }} `
            /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
            /p:Platform=${{ env.BUILD_PLATFORM }} `
            /p:PlatformToolset=v143 `
            /p:WindowsTargetPlatformVersion=10.0 `
            /m /verbosity:minimal 2>&1 | Tee-Object -FilePath solution_build.log
          $exitCode = $LASTEXITCODE
          if (!(Test-Path solution_build.log)) { "Build log was not generated" | Out-File solution_build.log }

          $fatalErrors = @()
          $warnings = 0
          $errorPatterns = @(
            'fatal error','fatal: ','error LNK\d{4}','LNK\d{4}',
            'unresolved external symbol','undefined reference',
            'LINK : fatal error','error CS\d+:','NETSDK\d+:',
            'error C\d{4}:','##\[error\]'
          )

          Get-Content solution_build.log | ForEach-Object {
            $line = $_
            if ($line -match '(?i)\bwarning\b') { $warnings++ }
            foreach ($p in $errorPatterns) {
              if ($line -match $p) { $fatalErrors += $line; break }
            }
          }

          $fatalErrors | Out-File solution_build.errors.txt
          "Warnings: $warnings" | Out-File solution_build.errors.txt -Append
          "ExitCode: $exitCode" | Out-File solution_build.errors.txt -Append

          if ($fatalErrors.Count -gt 0) {
            Write-Host "##[error] Build failed with $($fatalErrors.Count) fatal error lines."
            exit 0 # 错误时也继续执行后续步骤
          } elseif ($exitCode -ne 0) {
            Write-Host "##[error] Build exited with non-zero code ($exitCode)."
            exit 0 # 错误时也继续执行后续步骤
          } else {
            Write-Host "Build finished successfully."
          }

      - name: Upload Logs & Env Report
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            saer.txt
            dotnet_build.log
            solution_build.log
            solution_build.errors.txt

      - name: Upload Build Outputs
        uses: actions/upload-artifact@v4
        with:
          name: win-build-output
          path: |
            Project1/x64/${{ env.BUILD_CONFIGURATION }}/*.exe
            Project1/x64/${{ env.BUILD_CONFIGURATION }}/*.dll
          if-no-files-found: warn

  analyze-and-feedback:
    name: 构建决策与汇总反馈 (Ubuntu)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: 下载构建日志与环境
        uses: actions/download-artifact@v4
        with:
          name: build-logs
          path: .

      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: win-build-output
          path: ./build_output
        continue-on-error: true

      # ---------- 决策步骤：生成 build_decision.json (含 should_submit_pr) ----------
      - name: Run iFlow Build Decision
        id: iflow-decision
        uses: iflow-ai/iflow-cli-action@v2.0.0
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          model: "glm-4.6"
          timeout: "900"
          working_directory: "."
          prompt: |
            现在执行构建决策。生成 build_decision.json（UTF-8，无 BOM），不在控制台打印 JSON 内容。
            模块：
              C++: src/core/, src/main.cpp, src/CPP-parsers/
              第三方: src/third_party/
            获取 diff：git diff --name-only HEAD~1 HEAD；失败或为空 => 视为无 diff。
            规则：
              命中 main.cpp 或 src/core/ 任意文件 => build_cpp=true
              命中 src/third_party/ => build_lib=true
            use_cache：
              diff 文件数 ≤8 且未命中核心( main.cpp / src/core/ ) 且未命中第三方大型库文件(.lib/.dll/.h 新增或删除) => true；否则 false
            priority：
              仅列 true 模块；build_cpp 若为 true 置前；
              build_lib 若为 true 且 diff 含 .h/.lib/.dll 且 cpp 也需构建 => 放在 cpp 前，否则放 cpp 后；
            无 diff 兜底：全部 true, use_cache=false, priority=["cpp","lib"], reason 含“无 diff 全量构建”。
            若全部 false：兜底 build_cpp=true，reason 含“兜底”。
            新增字段 should_submit_pr：
              - 若有任一模块为 true 或检测到致命错误迹象（solution_build.log 中出现 fatal / LNK / unresolved） => should_submit_pr=true
              - 否则 should_submit_pr=false
            输出严格：
            {
              "build_cpp": <bool>,
              "build_lib": <bool>,
              "use_cache": <bool>,
              "priority": [ ... ],
              "should_submit_pr": <bool>,
              "reason": "≤400中文字符"
            }
            不加多余字段；true/false 小写；priority 不含 false 模块。
            仅写文件 build_decision.json。

            注意1:build_decision.json会被下一个AI接手,它会通过你描述的总结,请确保其格式正确且符合要求.
            注意2:你所在的环境只能允许做以上给你的任务,不要尝试做其他任何事情.(git除外)

      - name: 上传构建决策
        uses: actions/upload-artifact@v4
        with:
          name: build-decision
          path: build_decision.json

      # ---------- 缓存 iFlow CLI 结果 ----------
      - name: Cache iFlow CLI Results
        id: cache-iflow
        uses: actions/cache@v4
        with:
          path: |
            build_decision.json
            summary.md
          key: iflow-${{ github.run_id }}-${{ github.sha }}
          restore-keys: |
            iflow-${{ github.run_id }}-

      # ---------- 汇总步骤：生成 summary.md (Markdown 报告) ----------
      - name: Run iFlow Build Summary (Markdown)
        id: iflow-summary
        uses: iflow-ai/iflow-cli-action@v2.0.0
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          model: "glm-4.6"
          timeout: "900"
          working_directory: "."
          prompt: |
            读取文件：saer.txt, solution_build.log, build_decision.json(若存在)。
            生成 Markdown 报告 summary.md（UTF-8，无 BOM），用于 PR 评论。
            内容结构：
            # 构建汇总
            ## 总体状态
            - overall: success|failure|partial （规则：
              * 所有模块无致命错误且日志无 fatal/LNK/unresolved/NETSDK => success
              * 部分存在错误但非全部 => partial
              * 存在 fatal / 链接失败 / unresolved / NETSDK / 构建退出码非零 => failure）
            ## 模块状态
            - 列出：CPP / LIB / MAIN，各自 success|failure|unknown（用路径匹配与错误关键字）
            ## 关键问题
            - 归纳：fatal error / unresolved external symbol / undefined reference / LNKxxxx / NETSDK / 缺失依赖 等（最多列 12 条）
            ## 建议
            - 针对关键问题给可执行建议（如“修复未解析符号”“重新还原 NuGet 包”“检查第三方库版本”）
            ## 环境摘录
            - 从 saer.txt 中挑选 CPU, 内存, OS 一行概述
            ## 决策摘要
            - 从 build_decision.json 中列出：build_cpp / build_lib / use_cache / should_submit_pr / priority
            约束：
            - 控制总长度 ≤ 1200 中文字符
            - 不输出 JSON 到控制台
            - 标题使用一级/二级 Markdown，列表用短横线
            写入 summary.md（仅文件）。

            注意:你所在的环境只能允许做以上给你的任务,不要尝试做其他任何事情.(git除外)

      - name: 上传汇总 Markdown
        uses: actions/upload-artifact@v4
        with:
          name: build-summary-md
          path: summary.md

      # ---------- 检查 CLI 输出的构建状态并决定 workflow 是否失败 ----------
      - name: 检查构建状态 (基于 CLI 输出)
        shell: bash
        run: |
          if [ -f summary.md ]; then
            # 从 summary.md 中提取 overall 状态
            overall_status=$(grep -i "overall:" summary.md | head -1 | sed 's/.*overall:[[:space:]]*//I' | tr -d ' \t\n\r' || echo "unknown")
            echo "Overall status from CLI: $overall_status"
            
            if [ "$overall_status" = "failure" ]; then
              echo "##[error] CLI 判定构建失败 (overall: failure)"
              exit 1
            elif [ "$overall_status" = "partial" ]; then
              echo "##[warning] CLI 判定部分失败 (overall: partial)"
              # 可选：如果希望 partial 也算失败，取消注释下一行
              # exit 1
            else
              echo "CLI 判定构建状态: $overall_status"
            fi
          else
            echo "##[warning] 未找到 summary.md，无法检查构建状态"
          fi

      - name: Save iFlow CLI Results to Cache
        if: always()
        uses: actions/cache@v4
        with:
          path: |
            build_decision.json
            summary.md
          key: iflow-${{ github.run_id }}-${{ github.sha }}

      # ---------- 基于 should_submit_pr 决定是否评论 PR ----------
      - name: PR 评论 (基于决策)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let decision = {};
            let should = false;
            if (fs.existsSync('build_decision.json')) {
              try {
                decision = JSON.parse(fs.readFileSync('build_decision.json','utf8'));
                should = !!decision.should_submit_pr;
              } catch(e) {
                should = true; // 解析失败时默认评论，方便排错
              }
            } else {
              should = true; // 没决策文件也评论
            }

            let summary = '';
            if (fs.existsSync('summary.md')) {
              summary = fs.readFileSync('summary.md','utf8');
            } else {
              summary = 'warning: 未找到 summary.md，无法提供构建汇总内容。';
            }

            if (!should) {
              summary = '（iFlow 选择本次构建无需提交 PR 评论 should_submit_pr=false）\n\n' + summary;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });