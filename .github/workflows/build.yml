name: Build TCMT Windows Client

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

env:
  SOLUTION_FILE_PATH: Project1/Project1.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64
  ERROR_KEYWORDS: "error|warning|fatal|undefined"
  LOG_SUMMARY_LINES: 50
  FAIL_ERROR_REGEX: "(?i)(: error | fatal error| fatal: |\\berror LNK[0-9]{4}\\b|\\bLNK[0-9]{4}\\b|unresolved external symbol|undefined reference|LINK : fatal error)"
  MAIN_EXE: ""

jobs:
  system_info:
    name: System and Environment Report
    runs-on: windows-2022
    steps:
    - name: Print OS Info
      shell: pwsh
      run: |
        systeminfo | Out-File -FilePath system_info.txt -Append
        echo "`n==== DISK SPACE ====" | Out-File -FilePath system_info.txt -Append
        Get-PSDrive | Out-File -FilePath system_info.txt -Append
        echo "`n==== ENVIRONMENT ====" | Out-File -FilePath system_info.txt -Append
        Get-ChildItem Env: | Out-File -FilePath system_info.txt -Append
        echo "`n==== VSWHERE ====" | Out-File -FilePath system_info.txt -Append
        if (Test-Path "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe") {
          & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -all -prerelease -products * -format list | Out-File -FilePath system_info.txt -Append
        }
        echo "`n==== MSBuild Version ====" | Out-File -FilePath system_info.txt -Append
        $msbuild = Get-Command msbuild.exe -ErrorAction SilentlyContinue
        if ($msbuild) {
          msbuild -version | Out-File -FilePath system_info.txt -Append
        } else {
          $msbuilds = Get-ChildItem -Path "C:\Program Files\Microsoft Visual Studio" -Filter msbuild.exe -Recurse -ErrorAction SilentlyContinue
          if ($msbuilds) {
            foreach ($mb in $msbuilds) {
              echo "`n==== $($mb.FullName) ====" | Out-File -FilePath system_info.txt -Append
              & "$($mb.FullName)" -version | Out-File -FilePath system_info.txt -Append
            }
          } else {
            echo "msbuild.exe not found." | Out-File -FilePath system_info.txt -Append
          }
        }
        echo "`n==== cl.exe Version ====" | Out-File -FilePath system_info.txt -Append
        cl 2>&1 | Out-File -FilePath system_info.txt -Append
        echo "`n==== dotnet --info ====" | Out-File -FilePath system_info.txt -Append
        dotnet --info | Out-File -FilePath system_info.txt -Append
        echo "`n==== CUDA ====" | Out-File -FilePath system_info.txt -Append
        if (Test-Path "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA") {
          Get-ChildItem "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA" | Out-File -FilePath system_info.txt -Append
          if (Test-Path "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6\bin\nvcc.exe") {
            & "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6\bin\nvcc.exe" --version | Out-File -FilePath system_info.txt -Append
          }
        }
        echo "`n==== GPU INFO ====" | Out-File -FilePath system_info.txt -Append
        Get-WmiObject win32_VideoController | Format-List | Out-File -FilePath system_info.txt -Append
    - name: Upload System Info
      uses: actions/upload-artifact@v4
      with:
        name: system_info
        path: system_info.txt
  restore:
    runs-on: windows-2022
    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        ref: dev
        submodules: recursive
        fetch-depth: 0
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.x'
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.nuget/packages
        key: nuget-${{ runner.os }}-${{ hashFiles('**/*.sln','**/*.csproj','**/packages.config') }}
        restore-keys: |
          nuget-${{ runner.os }}-
    - name: NuGet Restore
      shell: pwsh
      run: |
        nuget restore ${{ env.SOLUTION_FILE_PATH }}

  cuda:
    runs-on: windows-2022
    steps:
    - name: Cache CUDA Toolkit
      uses: actions/cache@v4
      with:
        path: C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA
        key: cuda-12.6.0
    - name: Setup CUDA 12.6
      id: cuda_install
      uses: Jimver/cuda-toolkit@v0.2.18
      with:
        cuda: '12.6.0'
        method: 'network'
    - name: Check CUDA directory
      shell: pwsh
      run: |
        if (-not (Test-Path "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6")) {
          Write-Host "CUDA 12.6 安装失败！"
          exit 1
        } else {
          Write-Host "CUDA 12.6 安装成功。"
        }
    - name: 记录失败信息
      if: failure()
      shell: pwsh
      run: |
        Set-Content -Path cuda_install_failed.txt -Value "CUDA 12.6 安装失败，main 编译不会执行。"
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: cuda_install_failed
        path: cuda_install_failed.txt

  build_lib:
    runs-on: windows-2022
    needs: [restore]
    steps:
    - uses: actions/checkout@v5
      with:
        ref: dev
        submodules: recursive
        fetch-depth: 0
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.x'
    - name: Build LibreHardwareMonitorLib
      run: |
        cd src/third_party/LibreHardwareMonitor
        dotnet build LibreHardwareMonitorLib/LibreHardwareMonitorLib.csproj -c Release -f net472
    - name: 提取警告和错误
      shell: pwsh
      run: |
        $summaryLines = Get-Content ../../../../build_lib.log | Select-String -Pattern "${{ env.ERROR_KEYWORDS }}"
        $summary = if ($summaryLines){ $summaryLines | Out-String } else { "没有警告或错误。" }
        Set-Content build_lib.summary.txt $summary
    - name: 扫描致命错误并决定失败
      shell: pwsh
      run: |
        $lines = Get-Content ../../../../build_lib.log | Select-String -Pattern "${{ env.FAIL_ERROR_REGEX }}"
        $lines = $lines | Where-Object { $_.Line -notmatch '0 Error\(s\)' }
        if ($lines){
          Set-Content build_lib.errors.txt ($lines | ForEach-Object {$_.Line} | Out-String)
          exit 1
        }
    - name: 上传日志和总结
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build_lib_logs
        path: |
          ../../../../build_lib.log
          build_lib.summary.txt
          build_lib.errors.txt

  build_wpf:
    runs-on: windows-2022
    needs: [restore]
    steps:
    - uses: actions/checkout@v5
      with:
        ref: dev
        submodules: recursive
        fetch-depth: 0
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.x'
    - name: Build WPF-UI1
      run: |
        cd WPF-UI1
        dotnet build WPF-UI1.csproj -c Release
    - name: 提取警告和错误
      shell: pwsh
      run: |
        $summaryLines = Get-Content ../wpfui1_build.log | Select-String -Pattern "${{ env.ERROR_KEYWORDS }}"
        $summary = if ($summaryLines){ $summaryLines | Out-String } else { "没有警告或错误。" }
        Set-Content wpfui1_build.summary.txt $summary
    - name: 扫描致命错误并决定失败
      shell: pwsh
      run: |
        $lines = Get-Content ../wpfui1_build.log | Select-String -Pattern "${{ env.FAIL_ERROR_REGEX }}"
        $lines = $lines | Where-Object { $_.Line -notmatch '0 Error\(s\)' }
        if ($lines){
          Set-Content wpfui1_build.errors.txt ($lines | ForEach-Object {$_.Line} | Out-String)
          exit 1
        }
    - name: 上传日志和总结
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: wpfui1_build_logs
        path: |
          ../wpfui1_build.log
          wpfui1_build.summary.txt
          wpfui1_build.errors.txt

  build_cpp:
    runs-on: windows-2022
    steps:
    - uses: actions/checkout@v5
      with:
        ref: dev
        submodules: recursive
        fetch-depth: 0
    - name: Cache C++ build outputs
      uses: actions/cache@v4
      with:
        path: |
          src/CPP-parsers/CPP-parsers/x64/Release/
          src/CPP-parsers/CPP-parsers/x64/Debug/
          src/CPP-parsers/CPP-parsers/obj/
        key: cpp-build-${{ runner.os }}-${{ github.sha }}
        restore-keys: |
          cpp-build-${{ runner.os }}-
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    - name: Setup VS 环境
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    - name: Build CPP-parsers
      shell: pwsh
      run: |
        msbuild src/CPP-parsers/CPP-parsers/CPP-parsers.vcxproj /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143 /p:WindowsTargetPlatformVersion=10.0 /m /verbosity:minimal 2>&1 | Tee-Object -FilePath cpp_parsers_build.log
    - name: 提取警告和错误
      shell: pwsh
      run: |
        $summaryLines = Get-Content cpp_parsers_build.log | Select-String -Pattern "${{ env.ERROR_KEYWORDS }}"
        $summary = if ($summaryLines){ $summaryLines | Out-String } else { "没有警告或错误。" }
        Set-Content cpp_parsers_build.summary.txt $summary
    - name: 扫描致命错误并决定失败
      shell: pwsh
      run: |
        $lines = Get-Content cpp_parsers_build.log | Select-String -Pattern "${{ env.FAIL_ERROR_REGEX }}"
        $lines = $lines | Where-Object { $_.Line -notmatch '0 Error\(s\)' }
        if ($lines){
          Set-Content cpp_parsers_build.errors.txt ($lines | ForEach-Object {$_.Line} | Out-String)
          exit 1
        }
    - name: 上传日志和总结
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cpp_parsers_build_logs
        path: |
          cpp_parsers_build.log
          cpp_parsers_build.summary.txt
          cpp_parsers_build.errors.txt

  build_main:
    runs-on: windows-2022
    needs: [restore, cuda, build_lib, build_wpf, build_cpp]
    if: ${{ needs.restore.result == 'success' && needs.cuda.result == 'success' && needs.build_lib.result == 'success' && needs.build_wpf.result == 'success' && needs.build_cpp.result == 'success' }}
    steps:
    - uses: actions/checkout@v5
      with:
        ref: dev
        submodules: recursive
        fetch-depth: 0
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    - name: Setup VS 环境
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    - name: Build main project
      shell: pwsh
      run: |
        msbuild ${{ env.SOLUTION_FILE_PATH }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=${{ env.BUILD_PLATFORM }} /p:PlatformToolset=v143 /p:WindowsTargetPlatformVersion=10.0 /m /verbosity:minimal 2>&1 | Tee-Object -FilePath main_build.log
    - name: 提取警告和错误
      shell: pwsh
      run: |
        $summaryLines = Get-Content main_build.log | Select-String -Pattern "${{ env.ERROR_KEYWORDS }}"
        $summary = if ($summaryLines){ $summaryLines | Out-String } else { "没有警告或错误。" }
        Set-Content main_build.summary.txt $summary
    - name: 扫描致命错误并决定失败
      shell: pwsh
      run: |
        $lines = Get-Content main_build.log | Select-String -Pattern "${{ env.FAIL_ERROR_REGEX }}"
        $lines = $lines | Where-Object { $_.Line -notmatch '0 Error\(s\)' }
        if ($lines){
          Set-Content main_build.errors.txt ($lines | ForEach-Object {$_.Line} | Out-String)
          exit 1
        }
    - name: 上传日志和总结
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: main_build_logs
        path: |
          main_build.log
          main_build.summary.txt
          main_build.errors.txt
    - name: 上传主程序产物
      uses: actions/upload-artifact@v4
      with:
        name: TCMT-Windows-Client-${{ env.BUILD_PLATFORM }}-${{ env.BUILD_CONFIGURATION }}
        path: |
          Project1/x64/${{ env.BUILD_CONFIGURATION }}/*.exe
          Project1/x64/${{ env.BUILD_CONFIGURATION }}/*.dll
          Project1/x64/${{ env.BUILD_CONFIGURATION }}/*.pdb

  run_and_screenshot:
    runs-on: windows-2022
    needs: [build_main]
    if: needs.build_main.result == 'success'
    continue-on-error: true
    steps:
    - name: 下载主程序产物
      uses: actions/download-artifact@v4
      with:
        name: TCMT-Windows-Client-${{ env.BUILD_PLATFORM }}-${{ env.BUILD_CONFIGURATION }}
        path: app
    - name: 列出产物
      shell: pwsh
      run: |
        Get-ChildItem -Recurse app | ForEach-Object { $_.FullName }
    - name: 运行主程序并截图
      shell: pwsh
      run: |
        $exeToRun = $null
        if ($env:MAIN_EXE -and (Test-Path "app/$($env:MAIN_EXE)")) {
          $exeToRun = (Get-Item "app/$($env:MAIN_EXE)").FullName
        } else {
          $exes = Get-ChildItem -Path app -Filter *.exe -Recurse | Where-Object { $_.Name -notmatch 'vshost' }
          if (-not $exes) { Write-Host "未找到可执行文件"; exit 1 }
          $exeToRun = $exes[0].FullName
        }
        Start-Process -FilePath $exeToRun
        Start-Sleep -Seconds 6
        Add-Type -AssemblyName System.Windows.Forms
        Add-Type -AssemblyName System.Drawing
        $bounds = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
        $bitmap = New-Object System.Drawing.Bitmap $bounds.Width, $bounds.Height
        $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
        $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
        $bitmap.Save("run_screenshot.png")
        $graphics.Dispose(); $bitmap.Dispose()
    - name: 上传运行截图
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: run_screenshot
        path: run_screenshot.png

  report_error:
    if: always() && github.event_name == 'pull_request'
    runs-on: windows-2022
    needs: [restore, cuda, build_lib, build_wpf, build_cpp, build_main, run_and_screenshot]
    steps:
    - name: Download logs
      uses: actions/download-artifact@v4
      with:
        path: logs
    - name: 汇总所有模块警告和错误
      shell: pwsh
      run: |
        if (Test-Path "logs/cuda_install_failed") {
          $report = Get-Content "logs/cuda_install_failed/cuda_install_failed.txt" -Raw
        } else {
          $modules = @("restore","build_lib","wpfui1_build","cpp_parsers_build","main_build")
          $report = ""
          foreach ($m in $modules) {
            $dir = "logs/${m}_logs"
            $summaryFile = "$dir/${m}.summary.txt"
            $errFile = "$dir/${m}.errors.txt"
            if (Test-Path $summaryFile) {
              $txt = Get-Content $summaryFile -Raw
              $report += "`n==== $m ====`n$txt"
            } else {
              $report += "`n==== $m ====`n未执行或未生成日志。"
            }
            if (Test-Path $errFile) {
              $errTxt = Get-Content $errFile -Raw
              if ($errTxt.Trim()) {
                $report += "`n---- ${m} 致命错误行 ----`n$errTxt"
              }
            }
          }
          if ($report -eq "") { $report = "没有模块产生任何警告或错误。" }
        }
        New-Item -ItemType Directory -Path logs/out -Force | Out-Null
        Set-Content logs/out/ci_error_report.txt $report
    - name: 上传error report
      uses: actions/upload-artifact@v4
      with:
        name: ci_error_report
        path: logs/out/ci_error_report.txt

  comment-on-pr:
    if: failure() && github.event_name == 'pull_request'
    runs-on: windows-2022
    needs: [restore, cuda, build_lib, build_wpf, build_cpp, build_main, run_and_screenshot, report_error]
    steps:
    - name: Download logs
      uses: actions/download-artifact@v4
      with:
        path: logs
    - name: 评论到PR（仅copilot和dongge0210）
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_ACTOR: ${{ github.actor }}
        PR_AUTHOR: ${{ github.event.pull_request.user.login }}
      run: |
        $runtimeActor = $env:GITHUB_ACTOR
        $prAuthor = $env:PR_AUTHOR
        $allowed = @("github-copilot[bot]", "Copilot", "dongge0210")
        $isAllowed = ($allowed -contains $prAuthor) -or ($allowed -contains $runtimeActor)
        if (-not $isAllowed) {
          Write-Host "本 PR 作者($prAuthor) 不允许自动评论，跳过。"
          exit 0
        }
        $candidates = @(
          "logs/ci_error_report/ci_error_report.txt",
          "logs/out/ci_error_report.txt"
        )
        $errFile = $null
        foreach ($c in $candidates) {
          if (Test-Path $c -PathType Leaf) { $errFile = $c; break }
        }
        $errMsg = if ($errFile) { Get-Content $errFile -Raw } else { "缺失 ci_error_report.txt" }
        $actions_url = "https://github.com/$($env:GITHUB_REPOSITORY)/actions/runs/$($env:GITHUB_RUN_ID)"
        $comment = "@copilot @$prAuthor [Actions编译报告-MSVC] `n`nPR编译失败了  `n`n关键警告和错误日志如下：  `n````  `n$errMsg`n````  `n如需完整日志请查Actions artifacts。  `n$actions_url"
        $headers = @{
          Authorization = "token $env:GITHUB_TOKEN"
          "User-Agent" = "github-actions-powershell"
          "Accept" = "application/vnd.github+json"
        }
        $body = @{ body = $comment } | ConvertTo-Json -Depth 4
        $repo = $env:GITHUB_REPOSITORY
        $prNumber = $env:PR_NUMBER
        $url = "https://api.github.com/repos/$repo/issues/$prNumber/comments"
        Invoke-RestMethod -Uri $url -Method Post -Headers $headers -Body $body
