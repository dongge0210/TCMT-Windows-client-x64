name: Build TCMT Windows Client

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

env:
  SOLUTION_FILE_PATH: Project1/Project1.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64
  ERROR_KEYWORDS: "error|warning|fatal|undefined"
  FAIL_ERROR_REGEX: "(?i)(: error | fatal error| fatal: |\\berror LNK[0-9]{4}\\b|\\bLNK[0-9]{4}\\b|unresolved external symbol|undefined reference|LINK : fatal error)"
  MAIN_EXE: ""

# å¹¶è¡Œç»„1: S.A.E.R ç³»ç»Ÿç¯å¢ƒæŠ¥å‘Š
jobs:
  system_report:
    name: S.A.E.R (System and Environment Report)
    runs-on: windows-latest
    steps:
    - name: Setup MSVC Dev Cmd
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    - name: Generate System and Environment Report
      shell: pwsh
      run: |
        echo "=== SYSTEM AND ENVIRONMENT REPORT ===" | Out-File -FilePath saer.txt -Append
        echo "" | Out-File -FilePath saer.txt -Append
        echo "WSL Information:" | Out-File -FilePath saer.txt -Append
        wsl --version 2>$null | Out-File -FilePath saer.txt -Append
        echo "" | Out-File -FilePath saer.txt -Append
        
        echo "RAM Information:" | Out-File -FilePath saer.txt -Append
        Get-CimInstance -ClassName Win32_ComputerSystem | Select-Object TotalPhysicalMemory, @{Name="RAM(GB)";Expression={[math]::Round($_.TotalPhysicalMemory / 1GB, 2)}} | Format-Table | Out-File -FilePath saer.txt -Append
        echo "" | Out-File -FilePath saer.txt -Append
        
        echo "CPU Information:" | Out-File -FilePath saer.txt -Append
        Get-CimInstance -ClassName Win32_Processor | Select-Object Name, NumberOfCores, NumberOfLogicalProcessors, MaxClockSpeed | Format-Table | Out-File -FilePath saer.txt -Append
        echo "" | Out-File -FilePath saer.txt -Append
        
        echo "System Variables:" | Out-File -FilePath saer.txt -Append
        Get-ChildItem Env: | Where-Object { $_.Name -match "PATH|JAVA|PYTHON|NODE|CUDA|MSBUILD|VISUAL" } | Select-Object Name, Value | Format-Table | Out-File -FilePath saer.txt -Append
        echo "" | Out-File -FilePath saer.txt -Append
        
        echo "User Variables:" | Out-File -FilePath saer.txt -Append
        Get-ChildItem Env: | Where-Object { $_.Name -match "GITHUB|RUNNER|AGENT" } | Select-Object Name, Value | Format-Table | Out-File -FilePath saer.txt -Append
        echo "" | Out-File -FilePath saer.txt -Append
        
        echo "Git Version:" | Out-File -FilePath saer.txt -Append
        git --version | Out-File -FilePath saer.txt -Append
        echo "" | Out-File -FilePath saer.txt -Append
        
        echo "System Architecture:" | Out-File -FilePath saer.txt -Append
        $env:PROCESSOR_ARCHITECTURE | Out-File -FilePath saer.txt -Append
        $env:OS | Out-File -FilePath saer.txt -Append
        echo "" | Out-File -FilePath saer.txt -Append
        
        echo "Repository Structure:" | Out-File -FilePath saer.txt -Append
        git ls-tree -r HEAD --name-only | Out-File -FilePath saer.txt -Append
    - name: Upload System Info
      uses: actions/upload-artifact@v4
      with:
        name: system_info
        path: saer.txt

# å¹¶è¡Œç»„2: ç¯å¢ƒå‡†å¤‡å’Œä¾èµ–ç¼“å­˜
  setup_environment:
    name: Setup Environment and Dependencies
    runs-on: windows-latest
    outputs:
      cache-ready: ${{ steps.cache-check.outputs.cache-ready }}
      cuda-ready: ${{ steps.cuda-check.outputs.cuda-ready }}
    steps:
    - uses: actions/checkout@v5
      with:
        ref: dev
        submodules: recursive
        fetch-depth: 0
    
    # CUDAç¼“å­˜
    - name: Cache CUDA
      id: cache-cuda
      uses: actions/cache@v4
      with:
        path: C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6
        key: cuda-12.6-${{ runner.os }}
    
    # NuGetç¼“å­˜
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.x'
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.nuget/packages
        key: nuget-${{ runner.os }}-${{ hashFiles('**/*.sln','**/*.csproj','**/packages.config') }}
        restore-keys: |
          nuget-${{ runner.os }}-
    
    # MSBuildç¼“å­˜
    - name: Cache MSBuild packages
      uses: actions/cache@v4
      with:
        path: |
          C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild
          C:\Program Files (x86)\Microsoft Visual Studio\2022\Enterprise\MSBuild
        key: msbuild-${{ runner.os }}-${{ hashFiles('**/*.sln') }}
        restore-keys: |
          msbuild-${{ runner.os }}-
    
    # Windows SDKç¼“å­˜
    - name: Cache Windows SDK
      uses: actions/cache@v4
      with:
        path: |
          C:\Program Files (x86)\Windows Kits\10\lib
          C:\Program Files (x86)\Windows Kits\10\include
        key: windows-sdk-${{ runner.os }}-10.0.26100.0
        restore-keys: |
          windows-sdk-${{ runner.os }}-
    
    # å®‰è£…CUDAï¼ˆå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼‰
    - name: Setup CUDA 12.6
      if: steps.cache-cuda.outputs.cache-hit != 'true'
      uses: Jimver/cuda-toolkit@v0.2.18
      with:
        cuda: '12.6.0'
        method: 'network'
    
    # éªŒè¯CUDAå®‰è£…
    - name: Verify CUDA installation
      id: cuda-check
      shell: pwsh
      run: |
        $cudaReady = Test-Path "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6"
        echo "cuda-ready=$cudaReady" >> $GITHUB_OUTPUT
        if (-not $cudaReady) {
          Write-Host "CUDA 12.6 not found"
          exit 1
        } else {
          Write-Host "CUDA 12.6 found successfully"
        }
    
    # ç¼–è¯‘iflow-cli
    - name: Build iflow-cli
      shell: pwsh
      run: |
        # æ£€æŸ¥å¹¶å®‰è£…iflow-cli
        if (!(Get-Command iflow -ErrorAction SilentlyContinue)) {
          Write-Host "Installing iflow-cli..."
          npm install -g @iflow-ai/iflow-cli
        } else {
          Write-Host "iflow-cli already installed"
        }
        iflow --version
    
    - name: Check cache readiness
      id: cache-check
      shell: pwsh
      run: |
        $nugetReady = Test-Path "$env:USERPROFILE\.nuget\packages"
        $cacheReady = $nugetReady
        echo "cache-ready=$cacheReady" >> $GITHUB_OUTPUT
        Write-Host "Cache ready: $cacheReady"

# å¹¶è¡Œç»„3: iflow-cliæ™ºèƒ½å†³ç­–
  iflow_decision:
    name: iFlow CLI Smart Decision
    runs-on: windows-latest
    needs: [setup_environment]
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Run iFlow CLI Analysis
      uses: iflow-ai/iflow-cli-action@v2.0.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPOSITORY: ${{ github.repository }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        RUN_ID: ${{ github.run_id }}
      with:
        api_key: ${{ secrets.IFLOW_API_KEY }}
        model: "Qwen3-Coder"
        timeout: "1800"
        working_directory: "."
        prompt: |
          ## Role
          ä½ æ˜¯ä¸€ä¸ªCI/CDæ™ºèƒ½å†³ç­–åŠ©æ‰‹ï¼Œè´Ÿè´£åˆ†æä»£ç å˜æ›´å¹¶åˆ¶å®šæœ€ä¼˜çš„ç¼–è¯‘ç­–ç•¥ã€‚
          
          ## ä»»åŠ¡
          1. åˆ†æå½“å‰ä»£ç å˜æ›´æƒ…å†µ
          2. æ ¹æ®å˜æ›´å†…å®¹å†³å®šå“ªäº›æ¨¡å—éœ€è¦ç¼–è¯‘
          3. è¯„ä¼°ç¼“å­˜ç­–ç•¥çš„æœ‰æ•ˆæ€§
          4. åˆ¶å®šç¼–è¯‘ä¼˜å…ˆçº§å’Œä¾èµ–å…³ç³»
          
          ## æ­¥éª¤
          1. è¿è¡Œ `git diff --name-only HEAD~1 HEAD` è·å–å˜æ›´æ–‡ä»¶
          2. åˆ†æå˜æ›´æ–‡ä»¶å¯¹åº”çš„æ¨¡å—ï¼š
             - src/core/ æˆ– src/main.cpp â†’ cppæ¨¡å—éœ€è¦ç¼–è¯‘
             - WPF-UI1/ â†’ wpfæ¨¡å—éœ€è¦ç¼–è¯‘  
             - src/third_party/ â†’ libæ¨¡å—éœ€è¦ç¼–è¯‘
          3. åˆ›å»ºç¼–è¯‘å†³ç­–æ–‡ä»¶ build_decision.jsonï¼š
          ```json
          {
            "build_cpp": boolean,
            "build_wpf": boolean, 
            "build_lib": boolean,
            "use_cache": boolean,
            "priority": ["cpp", "wpf", "lib"],
            "reason": "å†³ç­–åŸå› è¯´æ˜"
          }
          ```
          4. ä¸Šä¼ å†³ç­–æ–‡ä»¶ä½œä¸ºartifactä¾›åç»­æ­¥éª¤ä½¿ç”¨
          
          ## ç¯å¢ƒä¿¡æ¯
          - CUDAå·²å®‰è£…: ${{ needs.setup_environment.outputs.cuda-ready }}
          - ç¼“å­˜å°±ç»ª: ${{ needs.setup_environment.outputs.cache-ready }}
          
          ## æ³¨æ„äº‹é¡¹
          - ä¼˜å…ˆè€ƒè™‘ç¼–è¯‘æ•ˆç‡å’Œèµ„æºåˆ©ç”¨
          - ç¡®ä¿ä¾èµ–å…³ç³»æ­£ç¡®
          - å¦‚æœä¸»é¡¹ç›®(src/main.cpp)æœ‰å˜æ›´ï¼Œå¿…é¡»ç¼–è¯‘cppæ¨¡å—
          - å¦‚æœWPFç•Œé¢æœ‰å˜æ›´ï¼Œå¿…é¡»ç¼–è¯‘wpfæ¨¡å—
          - å¦‚æœç¬¬ä¸‰æ–¹åº“æœ‰å˜æ›´ï¼Œå¿…é¡»ç¼–è¯‘libæ¨¡å—

# å¹¶è¡Œç»„4: æ™ºèƒ½ç¼–è¯‘
  build_components:
    name: Build Components
    runs-on: windows-latest
    needs: [setup_environment, iflow_decision]
    strategy:
      matrix:
        component: [lib, wpf, cpp, main]
    steps:
    - uses: actions/checkout@v5
      with:
        ref: dev
        submodules: recursive
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.x'
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup VS ç¯å¢ƒ
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    # ä¸‹è½½iflowå†³ç­–
    - name: Download build decision
      uses: actions/download-artifact@v4
      with:
        name: build-decision
        path: .
    
    # æ ¹æ®å†³ç­–å†³å®šæ˜¯å¦ç¼–è¯‘
    - name: Check build requirement
      id: check-build
      shell: pwsh
      run: |
        $decision = Get-Content "build_decision.json" | ConvertFrom-Json
        $component = "${{ matrix.component }}"
        $shouldBuild = $decision."build_$component"
        echo "should-build=$shouldBuild" >> $GITHUB_OUTPUT
        Write-Host "Component $component should build: $shouldBuild"
    
    # ç¼–è¯‘LibreHardwareMonitor
    - name: Build LibreHardwareMonitorLib
      if: matrix.component == 'lib' && steps.check-build.outputs.should-build == 'true'
      run: |
        cd src/third_party/LibreHardwareMonitor
        dotnet build LibreHardwareMonitorLib/LibreHardwareMonitorLib.csproj -c Release -f net472 --no-restore 2>&1 | Tee-Object -FilePath build_lib.log
      continue-on-error: true
    
    # ç¼–è¯‘WPF-UI1
    - name: Build WPF-UI1
      if: matrix.component == 'wpf' && steps.check-build.outputs.should-build == 'true'
      run: |
        cd WPF-UI1
        dotnet build WPF-UI1.csproj -c Release --no-restore 2>&1 | Tee-Object -FilePath wpfui1_build.log
      continue-on-error: true
    
    # ç¼–è¯‘CPP-parsers
    - name: Build CPP-parsers
      if: matrix.component == 'cpp' && steps.check-build.outputs.should-build == 'true'
      run: |
        msbuild src/CPP-parsers/CPP-parsers/CPP-parsers.vcxproj /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143 /p:WindowsTargetPlatformVersion=10.0 /m /verbosity:minimal 2>&1 | Tee-Object -FilePath cpp_parsers_build.log
      continue-on-error: true
    
    # ç¼–è¯‘ä¸»é¡¹ç›®
    - name: Build main project
      if: matrix.component == 'main' && steps.check-build.outputs.should-build == 'true'
      run: |
        nuget restore ${{ env.SOLUTION_FILE_PATH }}
        dotnet restore ${{ env.SOLUTION_FILE_PATH }}
        msbuild ${{ env.SOLUTION_FILE_PATH }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=${{ env.BUILD_PLATFORM }} /p:PlatformToolset=v143 /p:WindowsTargetPlatformVersion=10.0 /m /verbosity:minimal 2>&1 | Tee-Object -FilePath main_build.log
      continue-on-error: true
    
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.component }}-logs
        path: |
          build_*.log
          wpfui1_build.log
          cpp_parsers_build.log
          main_build.log

# å¹¶è¡Œç»„5: æµ‹è¯•è¿è¡Œï¼ˆ1åˆ†é’Ÿé™æ—¶ï¼‰
  test_application:
    name: Test Application (1min limited)
    runs-on: windows-latest
    needs: [build_components]
    continue-on-error: true
    timeout-minutes: 1
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: build-*-logs
        path: logs
    
    - name: Download main executable
      uses: actions/download-artifact@v4
      with:
        name: build-main-logs
        path: app
    
    - name: Run application test
      shell: pwsh
      run: |
        # æŸ¥æ‰¾ä¸»ç¨‹åº
        $exeToRun = $null
        if ($env:MAIN_EXE -and (Test-Path "app/$($env:MAIN_EXE)")) {
          $exeToRun = (Get-Item "app/$($env:MAIN_EXE)").FullName
        } else {
          $exes = Get-ChildItem -Path app -Filter *.exe -Recurse | Where-Object { $_.Name -notmatch 'vshost' }
          if ($exes) {
            $exeToRun = $exes[0].FullName
          }
        }
        
        if ($exeToRun) {
          Write-Host "Starting application: $exeToRun"
          Start-Process -FilePath $exeToRun
          Start-Sleep -Seconds 30
          
          # æˆªå›¾
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $bounds = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap $bounds.Width, $bounds.Height
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("test_screenshot.png")
          $graphics.Dispose(); $bitmap.Dispose()
          
          Write-Host "Application test completed"
        } else {
          Write-Host "No executable found for testing"
        }
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test_screenshot.png
          logs/

# å¹¶è¡Œç»„6: iflow-cliç¼–è¯‘æ€»ç»“
  iflow_summary:
    name: iFlow CLI Build Summary
    runs-on: windows-latest
    needs: [system_report, build_components, test_application]
    if: always()
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-artifacts
    
    - name: Run iFlow CLI Summary
      uses: iflow-ai/iflow-cli-action@v2.0.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPOSITORY: ${{ github.repository }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        RUN_ID: ${{ github.run_id }}
        BUILD_STATUS: ${{ job.status }}
      with:
        api_key: ${{ secrets.IFLOW_API_KEY }}
        model: "Qwen3-Coder"
        timeout: "1200"
        working_directory: "."
        prompt: |
          ## Role
          ä½ æ˜¯ä¸€ä¸ªCI/CDç»“æœæ€»ç»“åŠ©æ‰‹ï¼Œè´Ÿè´£åˆ†æç¼–è¯‘ç»“æœå¹¶ç”Ÿæˆä¸“ä¸šçš„æ€»ç»“æŠ¥å‘Šã€‚
          
          ## ä»»åŠ¡
          1. åˆ†ææ‰€æœ‰æ„å»ºæ—¥å¿—
          2. è¯„ä¼°ç¼–è¯‘æˆåŠŸç‡å’Œè´¨é‡
          3. è¯†åˆ«å…³é”®é—®é¢˜å’Œå»ºè®®
          4. ç”Ÿæˆç»“æ„åŒ–çš„æ€»ç»“æŠ¥å‘Š
          
          ## æ­¥éª¤
          1. æ£€æŸ¥ all-artifacts ç›®å½•ä¸‹çš„æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
          2. åˆ†ææ¯ä¸ªç»„ä»¶çš„ç¼–è¯‘ç»“æœï¼š
             - build-lib-logs: LibreHardwareMonitorç¼–è¯‘ç»“æœ
             - build-wpf-logs: WPF-UI1ç¼–è¯‘ç»“æœ  
             - build-cpp-logs: CPP-parsersç¼–è¯‘ç»“æœ
             - build-main-logs: ä¸»é¡¹ç›®ç¼–è¯‘ç»“æœ
             - test-results: æµ‹è¯•ç»“æœ
             - system_info: ç³»ç»Ÿç¯å¢ƒä¿¡æ¯
          3. ç”Ÿæˆæ€»ç»“æŠ¥å‘Š build_summary.jsonï¼š
          ```json
          {
            "overall_status": "success|failure|partial",
            "components": {
              "lib": {"status": "success|failure", "errors": 0, "warnings": 0},
              "wpf": {"status": "success|failure", "errors": 0, "warnings": 0},
              "cpp": {"status": "success|failure", "errors": 0, "warnings": 0},
              "main": {"status": "success|failure", "errors": 0, "warnings": 0}
            },
            "test_results": {"status": "success|failure|skipped", "screenshot": "boolean"},
            "key_issues": ["é—®é¢˜åˆ—è¡¨"],
            "recommendations": ["å»ºè®®åˆ—è¡¨"],
            "performance_metrics": {
              "build_time": "ä¼°ç®—æ—¶é—´",
              "cache_hit_rate": "ç¼“å­˜å‘½ä¸­ç‡"
            }
          }
          ```
          4. ç”Ÿæˆäººç±»å¯è¯»çš„æ€»ç»“æ–‡æœ¬
          
          ## æ³¨æ„äº‹é¡¹
          - æµ‹è¯•ç»“æœæƒé‡è¾ƒä½ï¼Œä¸»è¦å…³æ³¨ç¼–è¯‘ç»“æœ
          - ä¼˜å…ˆè¯†åˆ«é˜»å¡æ€§é”™è¯¯
          - æä¾›å…·ä½“çš„ä¿®å¤å»ºè®®
          - æ€»ç»“è¦ç®€æ´æ˜äº†ï¼Œä¾¿äºå¼€å‘è€…å¿«é€Ÿäº†è§£çŠ¶æ€

# å¹¶è¡Œç»„7: PRåé¦ˆæ¨é€
  pr_feedback:
    name: PR Feedback Push
    runs-on: windows-latest
    needs: [iflow_summary]
    if: failure() && github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v5
    
    - name: Download summary
      uses: actions/download-artifact@v4
      with:
        name: iflow-summary
        path: .
    
    - name: Post PR Comment
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        GITHUB_ACTOR: ${{ github.actor }}
        RUN_ID: ${{ github.run_id }}
      run: |
        $runtimeActor = $env:GITHUB_ACTOR
        $prAuthor = $env:PR_AUTHOR
        $allowed = @("github-copilot[bot]", "Copilot", "dongge0210")
        $isAllowed = ($allowed -contains $prAuthor) -or ($allowed -contains $runtimeActor)
        
        if (-not $isAllowed) {
          Write-Host "PRä½œè€…($prAuthor)ä¸å…è®¸è‡ªåŠ¨è¯„è®ºï¼Œè·³è¿‡"
          exit 0
        }
        
        # è¯»å–iFlowæ€»ç»“
        $summary = Get-Content "build_summary.json" | ConvertFrom-Json
        $summaryText = Get-Content "human_summary.txt" -Raw
        
        # ç¡®å®šæåŠç”¨æˆ·
        if ($prAuthor -eq "github-copilot[bot]" -or $prAuthor -eq "Copilot") {
          $mentionActor = "@dongge0210"
        } else {
          $mentionActor = "@$prAuthor"
        }
        
        $actionsUrl = "https://github.com/$($env:GITHUB_REPOSITORY)/actions/runs/$($env:RUN_ID)"
        $status = if ($summary.overall_status -eq "success") { "âœ… æˆåŠŸ" } elseif ($summary.overall_status -eq "failure") { "âŒ å¤±è´¥" } else { "âš ï¸ éƒ¨åˆ†æˆåŠŸ" }
        
        $comment = "@copilot $mentionAgent [iFlow CLI æ™ºèƒ½ç¼–è¯‘æŠ¥å‘Š] `n`n$status | PRç¼–è¯‘çŠ¶æ€ï¼š$($summary.overall_status.upper())`n`n## ğŸ“Š ç»„ä»¶çŠ¶æ€`n"
        
        foreach ($component in $summary.components.PSObject.Properties) {
          $compStatus = if ($component.Value.status -eq "success") { "âœ…" } else { "âŒ" }
          $comment += "- $($component.Name): $compStatus $($component.Value.errors)é”™è¯¯, $($component.Value.warnings)è­¦å‘Š`n"
        }
        
        if ($summary.test_results.status -ne "skipped") {
          $testStatus = if ($summary.test_results.status -eq "success") { "âœ…" } else { "âŒ" }
          $comment += "`n## ğŸ§ª æµ‹è¯•ç»“æœ`n- æµ‹è¯•çŠ¶æ€: $testStatus`n"
        }
        
        if ($summary.key_issues.Count -gt 0) {
          $comment += "`n## âš ï¸ å…³é”®é—®é¢˜`n"
          foreach ($issue in $summary.key_issues) {
            $comment += "- $issue`n"
          }
        }
        
        if ($summary.recommendations.Count -gt 0) {
          $comment += "`n## ğŸ’¡ å»ºè®®`n"
          foreach ($rec in $summary.recommendations) {
            $comment += "- $rec`n"
          }
        }
        
        $comment += "`n---`n[æŸ¥çœ‹è¯¦ç»†æ—¥å¿—]($actionsUrl) | ç”± iFlow CLI ç”Ÿæˆ"
        
        # å‘é€è¯„è®º
        $headers = @{
          Authorization = "token $env:GITHUB_TOKEN"
          "User-Agent" = "github-actions-powershell"
          "Accept" = "application/vnd.github+json"
        }
        $body = @{ body = $comment } | ConvertTo-Json -Depth 4
        $repo = $env:GITHUB_REPOSITORY
        $prNumber = $env:PR_NUMBER
        $url = "https://api.github.com/repos/$repo/issues/$prNumber/comments"
        Invoke-RestMethod -Uri $url -Method Post -Headers $headers -Body $body